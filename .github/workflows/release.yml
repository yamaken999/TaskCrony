name: Auto Release

on:
  push:
    branches: [ master ]
    paths:
      - '**.cs'
      - '**.csproj'
      - 'README.md'
      - 'LICENSE.txt'
      - '.github/workflows/**'

permissions:
  contents: write
  
jobs:
  release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore TaskCrony.csproj
      
    - name: Build
      run: dotnet build TaskCrony.csproj --configuration Release --no-restore --verbosity minimal
      
    - name: Publish
      run: dotnet publish TaskCrony.csproj --configuration Release --output ./publish --self-contained true --runtime win-x64 --verbosity minimal
      
    - name: Create and sign with self-signed certificate
      run: |
        # è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ä½œæˆ
        $cert = New-SelfSignedCertificate -Type CodeSigningCert -Subject "CN=TaskCrony Publisher" -KeyAlgorithm RSA -KeyLength 2048 -Provider "Microsoft Enhanced RSA and AES Cryptographic Provider" -KeyExportPolicy Exportable -KeyUsage DigitalSignature -FriendlyName "TaskCrony Code Signing Certificate" -CertStoreLocation "Cert:\CurrentUser\My" -NotAfter (Get-Date).AddYears(1)
        
        # è¨¼æ˜æ›¸ã®ã‚µãƒ ãƒ—ãƒªãƒ³ãƒˆã‚’å–å¾—
        $thumbprint = $cert.Thumbprint
        echo "è¨¼æ˜æ›¸ä½œæˆå®Œäº†: $thumbprint"
        
        # è¨¼æ˜æ›¸ã‚’ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸ã‚¹ãƒˆã‚¢ã«ã‚³ãƒ”ãƒ¼ï¼ˆä¿¡é ¼æ€§å‘ä¸Šã®ãŸã‚ï¼‰
        $store = New-Object System.Security.Cryptography.X509Certificates.X509Store([System.Security.Cryptography.X509Certificates.StoreName]::Root, [System.Security.Cryptography.X509Certificates.StoreLocation]::CurrentUser)
        $store.Open([System.Security.Cryptography.X509Certificates.OpenFlags]::ReadWrite)
        $store.Add($cert)
        $store.Close()
        echo "è¨¼æ˜æ›¸ã‚’ãƒ«ãƒ¼ãƒˆã‚¹ãƒˆã‚¢ã«è¿½åŠ ã—ã¾ã—ãŸ"
        
        # EXEãƒ•ã‚¡ã‚¤ãƒ«ã«ç½²å
        $exePath = "./publish/TaskCrony.exe"
        if (Test-Path $exePath) {
          Set-AuthenticodeSignature -FilePath $exePath -Certificate $cert -TimestampServer "http://timestamp.digicert.com"
          echo "EXEãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ç½²åå®Œäº†: $exePath"
          
          # ç½²åã®ç¢ºèª
          $signature = Get-AuthenticodeSignature -FilePath $exePath
          echo "ç½²åã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $($signature.Status)"
          echo "ç½²åè€…: $($signature.SignerCertificate.Subject)"
        } else {
          echo "ã‚¨ãƒ©ãƒ¼: EXEãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $exePath"
          exit 1
        }
      shell: pwsh
      
    - name: Verify signature
      run: |
        $exePath = "./publish/TaskCrony.exe"
        $signature = Get-AuthenticodeSignature -FilePath $exePath
        
        echo "=== ç½²åæ¤œè¨¼çµæœ ==="
        echo "ãƒ•ã‚¡ã‚¤ãƒ«: $exePath"
        echo "ç½²åã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $($signature.Status)"
        echo "ç½²åè€…: $($signature.SignerCertificate.Subject)"
        echo "è¨¼æ˜æ›¸æ‹‡å°: $($signature.SignerCertificate.Thumbprint)"
        echo "ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: $($signature.TimeStamperCertificate.Subject)"
        echo "æœ‰åŠ¹æœŸé™: $($signature.SignerCertificate.NotAfter)"
        
        if ($signature.Status -eq "Valid") {
          echo "âœ… ç½²åã¯æœ‰åŠ¹ã§ã™"
        } else {
          echo "âš ï¸ ç½²åã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $($signature.Status)"
        }
      shell: pwsh
      
    - name: Get version from csproj
      id: get_version
      run: |
        $csproj = Get-Content TaskCrony.csproj
        $version = ($csproj | Select-String -Pattern '<Version>(.*)</Version>').Matches[0].Groups[1].Value
        if ([string]::IsNullOrEmpty($version)) {
          $version = ($csproj | Select-String -Pattern '<AssemblyVersion>(.*)</AssemblyVersion>').Matches[0].Groups[1].Value
        }
        if ([string]::IsNullOrEmpty($version)) {
          $version = "1.3.2"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "æ¤œå‡ºã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³: $version"
      shell: pwsh
      
    - name: Create ZIP package
      run: |
        cd publish
        Compress-Archive -Path * -DestinationPath ../TaskCrony_v${{ steps.get_version.outputs.VERSION }}_Release.zip
        cd ..
        echo "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆå®Œäº†: TaskCrony_v${{ steps.get_version.outputs.VERSION }}_Release.zip"
      shell: pwsh
      
    - name: Generate release notes
      id: release_notes
      run: |
        $releaseNotes = @"
        ## TaskCrony v${{ steps.get_version.outputs.VERSION }}
        
        ### ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
        - **ã‚³ãƒ¼ãƒ‰ç½²åå¯¾å¿œ**: è‡ªå·±ç½²åè¨¼æ˜æ›¸ã«ã‚ˆã‚‹EXEãƒ•ã‚¡ã‚¤ãƒ«ç½²åã‚’å®Ÿè£…
        - Windows Defender SmartScreenè­¦å‘Šã®è»½æ¸›
        - å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿¡é ¼æ€§å‘ä¸Š
        
        ###  æ–°æ©Ÿèƒ½æ”¹å–„
        - ãƒ­ã‚°æ©Ÿèƒ½ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½è¿½åŠ   
        - åŒ…æ‹¬çš„ãªãƒ­ã‚°è¨˜éŒ²ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ7æ—¥é–“ä¿æŒï¼‰
        - GitHub APIçµ±åˆã«ã‚ˆã‚‹è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼
        - Windows ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼çµ±åˆ
        - æ—¥ä»˜ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚©ãƒ«ãƒ€è‡ªå‹•ä½œæˆ
        - BATãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•ç”Ÿæˆã¨ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æœ€é©åŒ–
        - è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        
        ###  é…å¸ƒãƒ•ã‚¡ã‚¤ãƒ«
        - **TaskCrony_v${{ steps.get_version.outputs.VERSION }}_Release.zip**: ç½²åæ¸ˆã¿è‡ªå·±å®Œçµå‹å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ« (ç´„146MB)
        - å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ«ãƒ¼ãƒˆã«é…ç½®ã§ç¢ºå®Ÿèµ·å‹•
        - ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã«ã‚ˆã‚Šå®‰å…¨æ€§ã‚’å‘ä¸Š
        
        ###  æŠ€è¡“ä»•æ§˜
        - å¯¾è±¡: Windows 10/11 (.NET 8.0)
        - PowerShellé€£æºã«ã‚ˆã‚‹æ—¥ä»˜è¨ˆç®—
        - UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆBOMå•é¡Œå¯¾å¿œæ¸ˆã¿ï¼‰
        - JSONè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
        - è‡ªå·±ç½²åè¨¼æ˜æ›¸ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ç½²å
        
        ###  ä½¿ç”¨æ–¹æ³•
        1. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±•é–‹
        2. TaskCrony.exeã‚’å®Ÿè¡Œï¼ˆç½²åæ¸ˆã¿ã§ã‚ˆã‚Šå®‰å…¨ï¼‰
        3. ã‚¿ã‚¹ã‚¯è¨­å®šã‚’å…¥åŠ›ã—ã¦ä½œæˆ
        4. Windows ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã§è‡ªå‹•å®Ÿè¡Œ
        
        ### ğŸ“‹ ç½²åæƒ…å ±
        - ç½²åè€…: TaskCrony Publisher
        - è¨¼æ˜æ›¸ã‚¿ã‚¤ãƒ—: è‡ªå·±ç½²åè¨¼æ˜æ›¸
        - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: DigiCert
        
        ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: $(Get-Date -Format "yyyyå¹´MMæœˆddæ—¥ HH:mm") JST
        "@
        
        $releaseNotes = $releaseNotes -replace "`r`n", "`n"
        echo "RELEASE_NOTES<<EOF" >> $env:GITHUB_OUTPUT
        echo $releaseNotes >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Check existing release
      id: check_release
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ v$version ã®æ—¢å­˜ãƒªãƒªãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        
        # æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ã‚’å‰Šé™¤
        $releaseExists = gh release view "v$version" 2>$null
        if ($LASTEXITCODE -eq 0) {
          echo "æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ v$version ã‚’å‰Šé™¤ä¸­..."
          gh release delete "v$version" --yes --cleanup-tag
          echo "æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
        } else {
          echo "æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        }
        
        # æ—¢å­˜ã®ã‚¿ã‚°ã‚’å‰Šé™¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
        $tagExists = git tag -l "v$version"
        if ($tagExists) {
          echo "æ—¢å­˜ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚° v$version ã‚’å‰Šé™¤ä¸­..."
          git tag -d "v$version"
          echo "ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
        }
        
        # æ—¢å­˜ã®ã‚¿ã‚°ã‚’å‰Šé™¤ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆï¼‰
        git ls-remote --tags origin | Select-String "v$version"
        if ($LASTEXITCODE -eq 0) {
          echo "æ—¢å­˜ã®ãƒªãƒ¢ãƒ¼ãƒˆã‚¿ã‚° v$version ã‚’å‰Šé™¤ä¸­..."
          git push origin ":refs/tags/v$version"
          echo "ãƒªãƒ¢ãƒ¼ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
        }
        
        echo "CREATE_RELEASE=true" >> $env:GITHUB_OUTPUT
        echo "ãƒªãƒªãƒ¼ã‚¹ä½œæˆæº–å‚™å®Œäº†"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh

    - name: Create Release
      if: steps.check_release.outputs.CREATE_RELEASE == 'true'
      run: |
        gh release create "v${{ steps.get_version.outputs.VERSION }}" `
          --title "TaskCrony v${{ steps.get_version.outputs.VERSION }}" `
          --notes '${{ steps.release_notes.outputs.RELEASE_NOTES }}' `
          "./TaskCrony_v${{ steps.get_version.outputs.VERSION }}_Release.zip#TaskCrony_v${{ steps.get_version.outputs.VERSION }}_Release.zip"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh