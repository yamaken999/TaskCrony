name: Auto Release

on:
  push:
    branches: [ master ]
    paths:
      - '**.cs'
      - '**.csproj'
      - 'README.md'
      - 'LICENSE.txt'
      - '.github/workflows/**'

permissions:
  contents: write
  
jobs:
  release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore TaskCrony.csproj
      
    - name: Build
      run: dotnet build TaskCrony.csproj --configuration Release --no-restore --verbosity minimal
      
    - name: Publish
      run: dotnet publish TaskCrony.csproj --configuration Release --output ./publish --self-contained true --runtime win-x64 --verbosity minimal
      
    - name: Simple code signing with timeout protection
      run: |
        echo "ğŸ” EXE ãƒ•ã‚¡ã‚¤ãƒ«ç½²åã‚’é–‹å§‹..."
        $exePath = "./publish/TaskCrony.exe"
        
        try {
          # ç½²åå‡¦ç†ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ5åˆ†ï¼‰
          $job = Start-Job -ScriptBlock {
            param($filePath)
            
            # ã‚·ãƒ³ãƒ—ãƒ«ãªè‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ä½œæˆ
            $cert = New-SelfSignedCertificate -DnsName "TaskCrony Publisher" -Type CodeSigning -CertStoreLocation "Cert:\CurrentUser\My" -NotAfter (Get-Date).AddYears(1)
            
            # EXEãƒ•ã‚¡ã‚¤ãƒ«ã«ç½²åï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãªã— - é«˜é€ŸåŒ–ï¼‰
            $result = Set-AuthenticodeSignature -FilePath $filePath -Certificate $cert
            
            return @{
              Status = $result.Status
              Certificate = $cert.Subject
              Thumbprint = $cert.Thumbprint
            }
          } -ArgumentList $exePath
          
          # 5åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
          if (Wait-Job $job -Timeout 300) {
            $result = Receive-Job $job
            echo "âœ… ç½²åå®Œäº†: $($result.Status)"
            echo "ğŸ“‹ è¨¼æ˜æ›¸: $($result.Certificate)"
            echo "ğŸ”‘ æ‹‡å°: $($result.Thumbprint)"
            
            # ç½²åç¢ºèª
            $signature = Get-AuthenticodeSignature -FilePath $exePath
            echo "ğŸ” æ¤œè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $($signature.Status)"
          } else {
            Stop-Job $job
            echo "âš ï¸ ç½²åå‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆ5åˆ†åˆ¶é™ï¼‰"
            echo "ğŸ“¦ ç½²åãªã—ã§ãƒªãƒªãƒ¼ã‚¹ã‚’ç¶šè¡Œã—ã¾ã™"
          }
          
          Remove-Job $job -Force
          
        } catch {
          echo "âš ï¸ ç½²åå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: $($_.Exception.Message)"
          echo "ğŸ“¦ ç½²åãªã—ã§ãƒªãƒªãƒ¼ã‚¹ã‚’ç¶šè¡Œã—ã¾ã™"
        }
        
        # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length / 1MB
          echo "ğŸ“ EXE ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $([math]::Round($fileSize, 2)) MB"
        } else {
          echo "âŒ EXE ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $exePath"
          exit 1
        }
      shell: pwsh
      
    - name: Get version from csproj
      id: get_version
      run: |
        $csproj = Get-Content TaskCrony.csproj
        $version = ($csproj | Select-String -Pattern '<Version>(.*)</Version>').Matches[0].Groups[1].Value
        if ([string]::IsNullOrEmpty($version)) {
          $version = ($csproj | Select-String -Pattern '<AssemblyVersion>(.*)</AssemblyVersion>').Matches[0].Groups[1].Value
        }
        if ([string]::IsNullOrEmpty($version)) {
          $version = "0.13.0"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "æ¤œå‡ºã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³: $version"
      shell: pwsh
      
    - name: Create ZIP package
      run: |
        cd publish
        Compress-Archive -Path * -DestinationPath ../TaskCrony_v${{ steps.get_version.outputs.VERSION }}_Release.zip
        cd ..
        echo "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆå®Œäº†: TaskCrony_v${{ steps.get_version.outputs.VERSION }}_Release.zip"
      shell: pwsh
      
    - name: Generate release notes
      id: release_notes
      run: |
        $releaseNotes = @"
        ## TaskCrony v${{ steps.get_version.outputs.VERSION }}
        
        ### ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼ˆæ”¹å–„ç‰ˆï¼‰
        - **ã‚³ãƒ¼ãƒ‰ç½²åå¯¾å¿œ**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¿è­·ä»˜ãè‡ªå·±ç½²åè¨¼æ˜æ›¸ã«ã‚ˆã‚‹ EXE ãƒ•ã‚¡ã‚¤ãƒ«ç½²å
        - Windows Defender SmartScreenè­¦å‘Šã®è»½æ¸›ï¼ˆå‡¦ç†æ™‚é–“æœ€é©åŒ–æ¸ˆã¿ï¼‰
        - å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿¡é ¼æ€§å‘ä¸Š
        
        ###  æ–°æ©Ÿèƒ½æ”¹å–„
        - ãƒ­ã‚°æ©Ÿèƒ½ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½è¿½åŠ   
        - åŒ…æ‹¬çš„ãªãƒ­ã‚°è¨˜éŒ²ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ7æ—¥é–“ä¿æŒï¼‰
        - GitHub APIçµ±åˆã«ã‚ˆã‚‹è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼
        - Windows ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼çµ±åˆ
        - æ—¥ä»˜ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚©ãƒ«ãƒ€è‡ªå‹•ä½œæˆ
        - BATãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•ç”Ÿæˆã¨ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æœ€é©åŒ–
        - è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        
        ###  é…å¸ƒãƒ•ã‚¡ã‚¤ãƒ«
        - **TaskCrony_v${{ steps.get_version.outputs.VERSION }}_Release.zip**: è‡ªå·±ç½²åæ¸ˆã¿å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ« (ç´„146MB)
        - å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ«ãƒ¼ãƒˆã«é…ç½®ã§ç¢ºå®Ÿèµ·å‹•
        - é«˜é€Ÿç½²åå‡¦ç†ã«ã‚ˆã‚Šãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’çŸ­ç¸®
        
        ###  æŠ€è¡“ä»•æ§˜
        - å¯¾è±¡: Windows 10/11 (.NET 8.0)
        - PowerShellé€£æºã«ã‚ˆã‚‹æ—¥ä»˜è¨ˆç®—
        - UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆBOMå•é¡Œå¯¾å¿œæ¸ˆã¿ï¼‰
        - JSONè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
        - è‡ªå·±ç½²åè¨¼æ˜æ›¸ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ç½²å
        
        ###  ä½¿ç”¨æ–¹æ³•
        1. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±•é–‹
        2. TaskCrony.exeã‚’å®Ÿè¡Œï¼ˆç½²åæ¸ˆã¿ã§ã‚ˆã‚Šå®‰å…¨ï¼‰
        3. ã‚¿ã‚¹ã‚¯è¨­å®šã‚’å…¥åŠ›ã—ã¦ä½œæˆ
        4. Windows ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã§è‡ªå‹•å®Ÿè¡Œ
        
        ### ğŸ“‹ ç½²åæƒ…å ±
        - ç½²åè€…: TaskCrony Publisher
        - è¨¼æ˜æ›¸ã‚¿ã‚¤ãƒ—: è‡ªå·±ç½²åè¨¼æ˜æ›¸ï¼ˆé«˜é€Ÿå‡¦ç†ç‰ˆï¼‰
        - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¿è­·: 5åˆ†åˆ¶é™ä»˜ã
        
        ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: $(Get-Date -Format "yyyyå¹´MMæœˆddæ—¥ HH:mm") JST
        "@
        
        $releaseNotes = $releaseNotes -replace "`r`n", "`n"
        echo "RELEASE_NOTES<<EOF" >> $env:GITHUB_OUTPUT
        echo $releaseNotes >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Check existing release
      id: check_release
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ v$version ã®æ—¢å­˜ãƒªãƒªãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        
        # æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ã‚’å‰Šé™¤
        $releaseExists = gh release view "v$version" 2>$null
        if ($LASTEXITCODE -eq 0) {
          echo "æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ v$version ã‚’å‰Šé™¤ä¸­..."
          gh release delete "v$version" --yes --cleanup-tag
          echo "æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
        } else {
          echo "æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        }
        
        # æ—¢å­˜ã®ã‚¿ã‚°ã‚’å‰Šé™¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
        $tagExists = git tag -l "v$version"
        if ($tagExists) {
          echo "æ—¢å­˜ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚° v$version ã‚’å‰Šé™¤ä¸­..."
          git tag -d "v$version"
          echo "ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
        }
        
        # æ—¢å­˜ã®ã‚¿ã‚°ã‚’å‰Šé™¤ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆï¼‰
        git ls-remote --tags origin | Select-String "v$version"
        if ($LASTEXITCODE -eq 0) {
          echo "æ—¢å­˜ã®ãƒªãƒ¢ãƒ¼ãƒˆã‚¿ã‚° v$version ã‚’å‰Šé™¤ä¸­..."
          git push origin ":refs/tags/v$version"
          echo "ãƒªãƒ¢ãƒ¼ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
        }
        
        echo "CREATE_RELEASE=true" >> $env:GITHUB_OUTPUT
        echo "ãƒªãƒªãƒ¼ã‚¹ä½œæˆæº–å‚™å®Œäº†"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh

    - name: Create Release
      if: steps.check_release.outputs.CREATE_RELEASE == 'true'
      run: |
        gh release create "v${{ steps.get_version.outputs.VERSION }}" `
          --title "TaskCrony v${{ steps.get_version.outputs.VERSION }}" `
          --notes '${{ steps.release_notes.outputs.RELEASE_NOTES }}' `
          "./TaskCrony_v${{ steps.get_version.outputs.VERSION }}_Release.zip#TaskCrony_v${{ steps.get_version.outputs.VERSION }}_Release.zip"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh